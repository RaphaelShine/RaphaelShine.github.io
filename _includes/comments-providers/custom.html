<!-- start custom comments snippet -->
<div id="comments">
  <h3>Comments</h3>
  <input id="nickname" placeholder="ë‹‰ë„¤ì„" maxlength="80" />
  <textarea id="comment_input" placeholder="ë‚´ìš©" maxlength="2000"></textarea>
  <button id="comment-registration">ë“±ë¡</button>

  <ul id="comment-list"></ul>
</div>

<script>
(function(){
  const API_BASE = "https://wandering-cake-347a.raphaelshine.workers.dev";
  const postId = "{{ page.id | slugify }}"; // í¬ìŠ¤íŠ¸ ì‹ë³„ì

  const $list = document.getElementById('comment-list');
  const $nick = document.getElementById('nickname');
  const $text = document.getElementById('comment_input');
  const $btn  = document.getElementById('comment-registration');

  // ì•„ì§ ì„œë²„ì— ë°˜ì˜ë˜ì§€ ì•Šì€ ë‚™ê´€ì  ì•„ì´í…œì„ ë³´ê´€
  const pendingItems = new Map(); // tempId -> item

  // --- util: escape + dom builders ---
  function escapeHTML(s='') {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  // ğŸ”§ ì‘ì„±ì í‘œì‹œëŠ” í•­ìƒ "ì´ìŠˆ ì œëª©(title) = ë‹‰ë„¤ì„"
  function buildCommentLI(item) {
    const { id, title, body, created_at, pending } = item;
    const li = document.createElement('li');
    li.className = 'comment';
    li.dataset.commentId = id || '';
    if (pending) li.dataset.pending = '1';

    const when = created_at ? new Date(created_at).toLocaleString() : '';
    const displayName = escapeHTML(title || ''); // â† í•µì‹¬ ë³€ê²½: user.login ì‚¬ìš© ì•ˆ í•¨

    li.innerHTML = `
      <article>
        <header>
          <strong class="comment-author">${displayName}</strong>
          <small class="comment-time">${when}</small>
          ${pending ? '<em class="comment-status"> (ë“±ë¡ ì¤‘)</em>' : ''}
        </header>
        <div class="content">${escapeHTML(body || '').replaceAll('\n','<br>')}</div>
      </article>
    `;
    return li;
  }

  // --- render helpers ---
  function renderReplace(items) {
    // ì„œë²„ ì•„ì´í…œì„ ì˜¤ë˜ëœâ†’ìµœì‹ ìœ¼ë¡œ ì •ë ¬
    const ordered = (items || []).slice()
      .sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));

    $list.textContent = '';
    ordered.forEach(it => $list.appendChild(buildCommentLI(it)));

    // ì•„ì§ ì„œë²„ì— ë°˜ì˜ë˜ì§€ ì•Šì€ ë‚™ê´€ì  ì•„ì´í…œì€ ë§¨ ë’¤(ìµœì‹  ìœ„ì¹˜)ì— ë‹¤ì‹œ ë¶™ì—¬ì¤€ë‹¤
    for (const [tempId, pendingItem] of pendingItems.entries()) {
      if (![...$list.querySelectorAll('li.comment')].some(li => li.dataset.commentId === tempId)) {
        $list.appendChild(buildCommentLI(pendingItem));
      }
    }
  }

  function renderAppend(item) {
    $list.appendChild(buildCommentLI(item)); // ë§¨ ë’¤ì— ì¶”ê°€ (ìµœì‹ ì´ ë§¨ ë’¤)
  }

  function replacePendingWithReal(tempId, realItem) {
    const li = $list.querySelector(`li.comment[data-comment-id="${tempId}"]`);
    if (li) {
      const newLi = buildCommentLI(realItem);
      $list.replaceChild(newLi, li);
    }
    pendingItems.delete(tempId);
  }

  // --- load (í•­ìƒ ìµœì‹ ) ---
  async function load() {
    const res = await fetch(
      `${API_BASE}/api/comments?postId=${encodeURIComponent(postId)}&ts=${Date.now()}`,
      { cache: 'no-store' }
    );
    const j = await res.json();
    renderReplace(j.items || []);
  }

  // --- submit with TRUE optimistic UI kept until server confirms ---
  async function submit() {
    const title = ($nick.value||'').trim(); // ë‹‰ë„¤ì„(=ì´ìŠˆ ì œëª©)
    const body  = ($text.value||'').trim(); // ë‚´ìš©
    if (!title) return alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
    if (!body)  return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');

    // ì¦‰ì‹œ í™”ë©´ ë°˜ì˜ìš© ì„ì‹œ ì•„ì´ë””
    const tempId = `temp-${Date.now()}-${Math.random().toString(36).slice(2)}`;
    const optimisticItem = {
      id: tempId,
      title,          // ì‘ì„±ì í‘œì‹œëŠ” titleë§Œ ì‚¬ìš©
      body,
      created_at: new Date().toISOString(),
      pending: true
    };

    // â‘  ë§¨ ë’¤(ìµœì‹  ìœ„ì¹˜)ì— ì¦‰ì‹œ ë³´ì´ê²Œ
    pendingItems.set(tempId, optimisticItem);
    renderAppend(optimisticItem);

    // UI ì ê¸ˆ
    $btn.disabled = true; $btn.textContent = 'ë“±ë¡ ì¤‘...';

    try {
      const res = await fetch(`${API_BASE}/api/comments`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ title, body, postId })
      });
      const data = await res.json();

      if (!res.ok || data.error) {
        // ì‹¤íŒ¨: ë‚™ê´€ì  í•­ëª© ì œê±°
        const li = $list.querySelector(`li.comment[data-comment-id="${tempId}"]`);
        if (li) li.remove();
        pendingItems.delete(tempId);
        throw new Error(data.error || 'ë“±ë¡ ì‹¤íŒ¨');
      }

      // ì…ë ¥ì°½ ì´ˆê¸°í™”
      $nick.value=''; $text.value='';

      // â‘¡ ì„±ê³µ: ì„œë²„ê°€ ì¤€ ì‹¤ì œ ì•„ì´í…œìœ¼ë¡œ êµì²´í•˜ê³  pending ì œê±°
      if (data.item) {
        replacePendingWithReal(tempId, data.item);
      } else {
        // ë“œë¬¼ê²Œ item ë¯¸í¬í•¨ì´ë©´ ì „ì²´ ìƒˆë¡œê³ ì¹¨
        pendingItems.delete(tempId);
        await load();
      }

      // â‘¢ ë°±ê·¸ë¼ìš´ë“œ ì¬ë™ê¸°í™”(í˜¹ì‹œ GitHub ì „íŒŒ ì§€ì—° ëŒ€ë¹„)
      fetch(`${API_BASE}/api/comments?postId=${encodeURIComponent(postId)}&ts=${Date.now()}`, { cache:'no-store' })
        .then(r => r.json())
        .then(j => renderReplace(j.items || []))
        .catch(()=>{ /* ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ëŠ” ë¬´ì‹œ */ });

    } catch (e) {
      alert(e && e.message ? e.message : 'ë“±ë¡ ì‹¤íŒ¨');
    } finally {
      $btn.disabled = false; $btn.textContent = 'ë“±ë¡';
    }
  }

  $btn.addEventListener('click', submit);
  load();
})();
</script>
<!-- end custom comments snippet -->
